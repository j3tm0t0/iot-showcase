
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>SORACOM LTE-M Button for Enterprise の位置情報を SORACOM Harvest と SORACOM Funk に連携して可視化と通知を行う</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid="0"
                  id="dist"
                  title="SORACOM LTE-M Button for Enterprise の位置情報を SORACOM Harvest と SORACOM Funk に連携して可視化と通知を行う"
                  environment="web"
                  feedback-link="https://github.com/soracom/iot-showcase">
    
      <google-codelab-step label="Overview" duration="1">
        <p>以下の内容について解説していきます。</p>
<ul>
<li>SORACOM LTE-M Button for Enterprise （以下、Enterprise Button） の登録について解説します。</li>
<li>Enterprise Button のクリックされた位置情報とクリック種別（シングルクリック、ダブルクリック、長押し）をSORACOM Harvest（以下、Harvest） に保存、可視化する方法について解説します。</li>
<li>Enterprise Button のクリックされた情報を SORACOM Funk（以下、Funk） と連携し、slackに通知する方法について解説します。</li>
<li>Enterprise Button 、位置情報連携 、Harvest 、Funk の解約方法について解説します。</li>
</ul>
<p class="image-container"><img src="img/b7212b54643bf40f.png"></p>
<aside class="warning"><p><strong>注意！</strong> このハンズオンの内容には有料のサービスが含まれます。自身のアカウントで実施される場合は料金をご確認の上実施してください。</p>
</aside>
<h2 is-upgraded>■目安となる料金</h2>
<p>Enterprise Button をお持ちであれば 約 100 円で実施できます。内訳は以下となります(2019 年 7 月 1 日 現在、税・送料別)。</p>
<ul>
<li>SORACOM LTE-M Button for Enterprise 購入料金 : <strong>5,980円</strong><br>(参考 <a href="https://soracom.jp/products/gadgets/enterprise_button/" target="_blank">https://soracom.jp/products/gadgets/enterprise_button/</a> )<br></li>
<li>SORACOM Air SIM(plan-KM1) 基本料金 : <strong>100 円 / 月<br></strong><br>SORACOM Air SIM(plan-KM1) データ使用料金 : <strong>0.5 円 / KB<br></strong><br>(参考 <a href="https://soracom.jp/services/air/cellular/price/#plan-km1" target="_blank">https://soracom.jp/services/air/cellular/price/#plan-km1</a>)</li>
<li>SORACOM Harvest 利用料金 : <strong>5 円 / 日</strong> (無料利用枠あり)<br><br>SORACOM Harvest 書き込みリクエスト料金 : <strong>0.004 円 / リクエスト</strong>(無料利用枠あり)<br><br>(参考 <a href="https://soracom.jp/services/harvest/price/" target="_blank">https://soracom.jp/services/harvest/price/</a>)<br></li>
<li>SORACOM Funk 利用料金 <strong>TBD</strong><br>(参考 <strong>TBD</strong>)<br></li>
<li>位置情報サービス 利用料金 <strong>TBD</strong><br>(参考 <strong>TBD</strong>)<br></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="必要なもの" duration="1">
        <p>このドキュメントを進めるにあたり以下のデバイスが必要となります。</p>
<ul>
<li>SORACOM LTE-M Button for Enterprise</li>
</ul>
<p>このドキュメントを進めるにあたり以下のアカウントが必要となります。</p>
<ul>
<li>SORACOM</li>
<li>AWS</li>
<li>Slack</li>
</ul>
<p>このドキュメントを進めるにあたり以下の知識が必要となります。</p>
<ul>
<li>AWS Lambda (node.js のサンプルコードは用意しています)</li>
<li>Slack Webhook (スクリーンショット付きのチュートリアルは用意しています)</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="SORACOM アカウントの登録" duration="0">
        <h2 is-upgraded>■SORACOM アカウントの作成</h2>
<p>SORACOM Webコンソール ( https://console.soracom.io/#/signup) にアクセスします。<br>使用する SIM の種類を選択します。日本向けの SORACOM Air SIM を利用する場合は、カバレッジタイプ Japan を選択します。</p>
<p class="image-container"><img src="img/8a6c8db40b66b429.png"></p>
<p>「アカウント作成」画面が表示されますのでメールアドレスおよびパスワードを入力します。 また、契約者が個人であるか法人であるかを選び、法人の場合はさらに契約者の情報を入力します。 最後に規約に同意するためのチェックボックスを入れ、「アカウントを作成」ボタンを押します。</p>
<p class="image-container"><img src="img/edbe24dd6dffd14.png"></p>
<p>複数人でAir SIMの管理を行う場合は、事前にメーリングリストのアドレスを取得するなど、共有のメールアドレスをご利用ください。 下記の画面が表示されるので、メールを確認してください。</p>
<p class="image-container"><img src="img/1adde2c2005beece.png"></p>
<p>メールが届いたらリンクをクリックしてください。</p>
<p class="image-container"><img src="img/54c90fc3f2989295.png"></p>
<p>自動的にログイン画面に遷移しますので、メールアドレスとパスワードを入力してログインしてください。</p>
<h2 is-upgraded>■ユーザーコンソールへのログイン</h2>
<p>ログイン画面が表示されるので、アカウント作成時に登録したメールアドレスとパスワードを入力し、 [ログイン] ボタンをクリックしてください。(ログイン画面が表示されない場合はブラウザで https://console.soracom.io にアクセスします。)</p>
<p class="image-container"><img src="img/cf07195512a66659.png"></p>
<p>以下のような「SIM管理」画面が表示されたらログイン完了です。引き続き、支払情報の設定に進みましょう！</p>
<p class="image-container"><img src="img/5720f38c64d59aa.png"></p>
<h2 is-upgraded>■支払情報の設定</h2>
<p>通信料の支払い方法はクレジットカードになります。クレジットカードの情報を登録するには、メイン画面上部のユーザー名から[お支払い方法設定]を開きます。</p>
<p class="image-container"><img src="img/dc45136765ba0452.png"></p>
<p>お支払方法で各情報を入力し、支払い方法を登録します。</p>
<p class="image-container"><img src="img/df5b6e569eddbaa8.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Enterprise Button の利用を開始する" duration="10">
        <p>Enterprise Button の購入から利用開始までを解説します。</p>
<h2 is-upgraded>■ Enterprise Button の購入</h2>
<p>すでに購入・登録している場合は、<a href="https://console.soracom.io" target="_blank">SORACOM ユーザーコンソール</a> から確認できます。Enterprise Button は、 Air SIM 管理画面からplan-KM1 の SIM のひとつとして確認できます。</p>
<p class="image-container"><img src="img/230fc90391902197.png"></p>
<p>これから購入される場合は、<a href="https://console.soracom.io/#/orders" target="_blank">ユーザーコンソールの発注画面</a> から新規注文ができます。</p>
<h2 is-upgraded>■ Enterprise Button の利用開始</h2>
<p>すでにユーザーコンソールから購入された場合は、<a href="https://console.soracom.io/#/orders" target="_blank">ユーザーコンソールの発注画面</a> から「受け取り確認」を頂くことで登録され、確認できるようになります。</p>
<p class="image-container"><img src="img/201c4070a0e0c410.png"></p>
<p>イベントなどで Enterprise Button の現物を購入された場合は <a href="https://console.soracom.io" target="_blank">SIM 管理の画面</a> から以下の手順で登録が可能です。</p>
<p>[1] &#34;SIM 登録&#34; ボタンを押下して登録画面を開く<br>[2] IMSI およびパスコードを入力し &#34;登録&#34; を押下することで登録を完了させる</p>
<p class="image-container"><img src="img/d73e07cc418a60e6.png"></p>
<h2 is-upgraded>■ Enterprise Button の名前を設定する</h2>
<p>&#34;名前&#34; 列の 鉛筆マークをクリックすることで、たとえば &#34;Enterprise Button&#34; などと名前の設定ができます。</p>
<p class="image-container"><img src="img/a2729acab9632394.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Harvest に Enterprise Button の位置情報とクリックタイプを保存する" duration="20">
        <p>Enterprise Button から Harvest に対して位置情報とクリックタイプを保存する方法を解説します。</p>
<h2 is-upgraded>■グループを作成し、Enterprise Button を所属させる</h2>
<p>[1] <a href="https://console.soracom.io" target="_blank">ユーザーコンソール</a> の &#34;Menu&#34; から &#34;SIM グループ&#34; を選択します。<br><img src="img/ca745a7141e18977.png"><img src="img/1bfea3679a62458e.png"><br>[2] &#34;追加&#34; ボタンよりグループを作成します。任意の名前 (たとえば &#34;handson-button&#34;) をつけて &#34;グループ作成&#34; を押下します。<br><img src="img/3a89d27535beaeec.png"><br>[3] &#34;Menu&#34; から &#34;SIM 管理&#34; を選択します。<br><img src="img/cfefd5bec4374aee.png"><br>[4] Enterprise Button の SIM の左端にある チェックボックスを選択し、&#34;操作&#34; =&gt; &#34;所属グループ変更&#34; を選択します。<br><img src="img/f624eb4b5ed3a0db.png"><br>[5] &#34;新しい所属グループ&#34; には作成したグループを選択し、&#34;グループ変更&#34; を押下します。<br><img src="img/26abb38cbcf2bb8e.png"></p>
<h2 is-upgraded>■ Harvest の利用を開始する</h2>
<p>[1] 所属させたグループの名前を押下することで、グループ設定の変更画面に遷移します。<br><img src="img/a667d571099a25b6.png"><br>[2] &#34;SORACOM Harvest設定&#34; を開き、&#34;OFF&#34; となっているスイッチを押下して &#34;ON&#34; に変更します。&#34;保存&#34; を押下すれば、Harvest が有効となります。ポップアップされる注意事項では &#34;OK&#34; を押下します。<strong>&#34;保存&#34; を押下しないと設定が変更されないのでご注意ください。<br></strong><img src="img/a58c1188ffc1399e.png"></p>
<h2 is-upgraded>■位置情報サービス の利用を開始する</h2>
<p>&#34;SORACOM Air for Cellular 設定&#34; を開き、&#34;位置情報サービス&#34; を &#34;ON&#34; に変更し、&#34;保存&#34; を押下します。<br><img src="img/fe775ff2aadcca8c.png"></p>
<h2 is-upgraded>■バイナリパーサー を設定する</h2>
<p>&#34;SORACOM Air for Cellular 設定&#34; を開き、&#34;バイナリパーサー設定&#34; を &#34;ON&#34; に変更し、フォーマットには <code>@button</code> と記載し、&#34;保存&#34; を押下します。<br><img src="img/4fa57e56ddf42fee.png"></p>
<h2 is-upgraded>■ Enterprise Button を押して Harvest を確認する</h2>
<p>いよいよ Enterprise Button を押します。ボタンをクリックし、 LED がオレンジ色となり、数秒後に緑色となればデータの送信は成功です。<br><img src="img/d8a87790dd590386.png"></p>
<p>Harvest 上のデータは以下の手順で確認できます。<br>[1] &#34;Menu&#34; から &#34;SIM 管理&#34; を選択します。<br><img src="img/cfefd5bec4374aee.png"><br>[2] Enterprise Button の SIM の左端にある チェックボックスを選択し、&#34;操作&#34; =&gt; &#34;データを確認&#34; を選択します。<br><img src="img/fdb816f9d3638a9d.png"><br>[3] &#34;データ&#34; にて、&#34;clickTypeName&#34; が &#34;SINGLE&#34; であることを確認します。<br><img src="img/8f4ab663d01792da.png"><br>[4] マップピンアイコンを選択することで表示を地図に変更して、位置情報を確認します。左上の &#34;+&#34; や &#34;-&#34; でズームを調整できます。&#34;データ&#34; にも locaton 形式で位置情報が入っています。<br><img src="img/a8f9d7623c0a6e4d.png"><br>[5] Enterprise Button は以下 3 種類のクリックに対応しています。それぞれぜひ試してみてください。連続してデータの送信をしたい場合は Harvest の画面にて「自動更新」を &#34;ON&#34; にしてみてください</p>
<p>クリックの種類<br>・シングル ... 短く(1.2秒未満) 1回押す<br><br>・ダブル ... 2秒以内にシングルクリックを2回行う<br><br>・ロング ... 1.2秒以上押し続ける。</p>
<p class="image-container"><img src="img/1ac2984b2272da9d.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="Funk で位置情報とクリックタイプを slack に通知する" duration="20">
        <p>Enterprise Button から Funk を介して AWS Lambda にクリックされた位置の情報とクリックタイプを連携し、slack へ通知する方法を解説します。</p>
<h2 is-upgraded>■ slack を設定する</h2>
<p><strong>当ハンズオンは Slack Webhook について知識のある方を対象にしているため、この節について詳細は解説しません。</strong></p>
<p>Slack の登録は以下のリンクより可能です。<br>https://slack.com/get-started</p>
<p>Slack の Incoming Webhook を有効にし、Webhook URL を控えておきます。下の画像は Microsoft Store 版 Slack のスクリーンショットを載せています。</p>
<p class="image-container"><img src="img/97d3f02ca0bab4b3.png"><img src="img/a65f09e618373c5.png"><img src="img/8064e1195040f10a.png"><img src="img/67ad7b1cb49ff6d6.png"><img src="img/8ed6f3a37d8efe73.png"></p>
<h2 is-upgraded>■ AWS Lambda を設定する</h2>
<p><strong>当ハンズオンは AWS Lambda について知識のある方を対象にしているため、この節について詳細は解説しません。<br></strong><br>[1] <a href="https://ap-northeast-1.console.aws.amazon.com/lambda/home?region=ap-northeast-1#/create" target="_blank">AWS Lambda 作成画面</a> を開きます。<br>[2] 任意の関数名をつけ、ランタイムは &#34;Node.js 10.x&#34; を選択し、実行ロールは &#34;基本的な Lambda アクセス権限で新しいロールを作成&#34; とし &#34;関数の作成&#34; を選択します。<br><img src="img/9c638ade9fac6150.png"><br>[3] 以下のコードを貼り付け、環境変数 &#34;SLACK_URL&#34; に先ほど設定した Slack の Webhook URL を貼り付けて &#34;保存&#34; を押下します。</p>
<pre><code>const https = require(&#39;https&#39;);
const url = require(&#39;url&#39;);
const slackUrl = process.env.SLACK_URL

exports.handler = function(e, ctx, cb) {
    console.log(&#39;event: %j&#39;, e)
    console.log(&#39;context: %j&#39;, ctx)

    if(!e.clickTypeName)
    {
        cb(false, {&#34;result&#34;:&#34;ng&#34;, &#34;reason&#34;:&#39;invalid payload: &#39;+JSON.stringify(e)})
    }

    var slackReqOptions = url.parse(slackUrl);
    slackReqOptions.method = &#39;POST&#39;;
    slackReqOptions.headers = { &#39;Content-Type&#39;: &#39;application/json&#39; };
    var payload = {
        &#34;icon_emoji&#34;:&#34;:button:&#34;,
        &#34;text&#34;: `ボタンが *${e.clickTypeName}* クリックされました！ (バッテリーレベルは *${e.batteryLevel * 100}* % です)`,
        &#34;attachments&#34;: [
            {
                &#34;title&#34;: &#34;clientContext&#34;,
                &#34;color&#34;: &#34;#34cdd7&#34;,
                &#34;text&#34;: &#34;```\n&#34;+JSON.stringify(ctx.clientContext,null,&#34;  &#34;)+&#34;```\n&#34;,
                &#34;mrkdwn_in&#34;: [&#34;text&#34;]
            },
            {
                &#34;title&#34;: &#34;event&#34;,
                &#34;color&#34;: &#34;#e47911&#34;,
                &#34;text&#34;: &#34;```\n&#34;+JSON.stringify(e,null,&#34;  &#34;)+&#34;```\n&#34;,
                &#34;mrkdwn_in&#34;: [&#34;text&#34;]
            }
        ]
    };
    if(ctx.clientContext.locationQueryResult === &#34;success&#34;)
    {
        payload.attachments.push(
            {
                &#34;title&#34;: &#34;location&#34;,
                &#34;color&#34;: &#34;#800080&#34;,
                &#34;text&#34;: `&lt;https://www.google.com/maps/search/?api=1&amp;query=${ctx.clientContext.location.lat},${ctx.clientContext.location.lon}|位置情報あり&gt; ${ctx.clientContext.location.lat},${ctx.clientContext.location.lon}`
            }
        );
    }
    var body = JSON.stringify(payload);
    slackReqOptions.headers = {
        &#39;Content-Type&#39;: &#39;application/json&#39;,
        &#39;Content-Length&#39;: Buffer.byteLength(body),
    };
    var req = https.request(slackReqOptions, function(res) {
        if (res.statusCode === 200) {
            console.log(&#39;Posted to slack&#39;);
            cb(null, {&#34;result&#34;:&#34;ok&#34;});
        } else {
            cb(false, {&#34;result&#34;:&#34;ng&#34;, &#34;reason&#34;:&#39;Failed to post slack &#39; + res.statusCode})
        }
        return res;
    });
    req.write(body);
    req.end();
};

</code></pre>
<p><img src="img/692649db8554c48f.png"><br>[4] Lambda の arn をコピーします。<br><img src="img/a77a6f34e0897113.png"></p>
<h2 is-upgraded>■ Lambda 実行用の AWS IAM ユーザーを作成する</h2>
<p>[1] IAM ポリシー を作成します。詳細は解説しませんが、こちらの JSON に先ほどコピーした Lamda の arn を入れて利用ください。</p>
<pre><code>{
    &#34;Version&#34;: &#34;2012-10-17&#34;,
    &#34;Statement&#34;: [
        {
            &#34;Sid&#34;: &#34;AllowAuroraToExampleFunction&#34;,
            &#34;Effect&#34;: &#34;Allow&#34;,
            &#34;Action&#34;: &#34;lambda:InvokeFunction&#34;,
            &#34;Resource&#34;: &#34;先ほどコピーしたARN&#34;
        }
    ]
}
</code></pre>
<p><img src="img/6d49db4412a79f27.png"><img src="img/408dd64460001825.png"><img src="img/bf4d58cacddfe678.png"><br>[2] 作成した IAM ポリシーをアタッチしたユーザーを作成します。タグは不要です。<br><img src="img/6cd03370f6b2c349.png"><img src="img/1bc6388909b83fab.png"><br>[3] 作成したユーザーのアクセスキー ID およびシークレットアクセスキーをコピーします。<br><img src="img/7d499357aa54ecd8.png"></p>
<h2 is-upgraded>■ AWS IAM ユーザーの認証情報を SORACOM に登録する</h2>
<p>[1] SORACOM ユーザーコンソールの右上のユーザー名を押下し、&#34;セキュリティ&#34; を選択します<br><img src="img/c65be1ae403b2a6e.png"><br>[2] &#34;認証情報ストア&#34; =&gt; &#34;認証情報を登録&#34; を選択します<br><img src="img/87a7060594647710.png"><br>[3] &#34;認証情報 ID&#34; は任意に記載し、先ほどコピーした AWS ユーザーのアクセスキー ID およびシークレットアクセスキーを入力し、&#34;登録&#34; を押下します。<br><img src="img/5c992dcd224f1bda.png"></p>
<h2 is-upgraded>■ Funk を設定する</h2>
<p>[1] ユーザーコンソールの <a href="https://console.soracom.io/#/?coverage_type=jp" target="_blank">&#34;SIM 管理&#34; メニュー</a>より、作成した SIM のグループ名を選択します。<br><img src="img/a667d571099a25b6.png"><br>[2] &#34;SORACOM Funk 設定&#34; を開き、&#34;ON&#34; にし、先ほど登録した認証情報やコピーした Lambda の arn を入力して &#34;保存&#34; を押下します。<br><img src="img/9d4514cf434705cc.png"></p>
<h2 is-upgraded>■ Enterprise Button を押して slack 通知を確認する</h2>
<p>以下のような通知が確認できます。<br><img src="img/677287fe61978677.png"><br>確認できない場合は、Lambda のメトリックにて「ログが出ているか」「エラーが出ていないか」を確認してください。</p>


      </google-codelab-step>
    
      <google-codelab-step label="サービスの解除と課金の停止" duration="10">
        <p>Enterprise Button 、位置情報サービス 、Harvest 、Funk の解約方法について解説します。</p>
<h2 is-upgraded>■位置情報サービス、Harvest、Funk の解約</h2>
<p>位置情報サービス、Harvest、Funk を有効にしたグループ配下に SIM があると基本使用料金が発生します。詳細は 目安となる料金 の章をご確認さい。<br>これらを解約したい場合は、それぞれの機能についてグループで無効化します。</p>
<p>[1] ユーザーコンソールの <a href="https://console.soracom.io/#/?coverage_type=jp" target="_blank">&#34;SIM 管理&#34; メニュー</a>より、作成した SIM のグループ名を選択します。<br><img src="img/a667d571099a25b6.png"><br>[2] &#34;SORACOM Funk 設定&#34; を開き、&#34;OFF&#34; にし &#34;保存&#34; を押下します。<br><img src="img/fa4b91c77b23a287.png"><br>[3] &#34;SORACOM Harvest 設定&#34; を開き、OFF にし &#34;保存&#34; を押下します。<br><img src="img/77427757d59603a9.png"><br>[4] &#34;SORACOM Air for Cellular 設定&#34; を開き、&#34;位置情報サービス&#34; および &#34;バイナリパーサー設定&#34; を &#34;OFF&#34; にし &#34;保存&#34; を押下します。<br>[5] <a href="https://console.soracom.io" target="_blank">ユーザーコンソール</a> から 対象の SIM のチェックボックスを選択 =&gt; &#34;操作&#34; =&gt; &#34;所属グループ変更&#34; を選択します。<br><img src="img/ce19afd97895bc85.png"><br>[6] &#34;グループ解除&#34; を選択します。<br><img src="img/be805c27e4409d73.png"></p>
<h2 is-upgraded>■ Enterprise Button の解約</h2>
<p>Enterprise Button は plan-KM1 の基本使用料が発生します。詳細は 目安となる料金 の章をご確認ください。<br>もし Enterprise Button の解約を希望する場合は以下の手順で可能です。</p>
<aside class="warning"><p><strong>注意！</strong> Enterprise Button を解約した場合、2度と利用することはできません。</p>
</aside>
<p>[1] <a href="https://console.soracom.io" target="_blank">ユーザーコンソール</a> から 対象の SIM のチェックボックスを選択 =&gt; &#34;操作&#34; =&gt; &#34;解約&#34; を選択します。<br><img src="img/ef6a80d92cda65fe.png"><br>[2] &#34;解約プロテクション&#34; を &#34;OFF&#34; にして &#34;解約する&#34; を選択します。<br><img src="img/e23b030e4e3cea6a.png"></p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>

</body>
</html>
